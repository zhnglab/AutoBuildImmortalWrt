#!/bin/sh
# ================== ğŸ§© ImmortalWrt å›ºä»¶è‡ªå®šä¹‰ä¿¡æ¯ ==================
# ä½œè€…ï¼šMr.Zhang
# åŠŸèƒ½ï¼š
# 1ï¸âƒ£ ä¿®æ”¹ LuCI æ¦‚è§ˆé¡µå›ºä»¶ç‰ˆæœ¬
# 2ï¸âƒ£ ä¿®æ”¹ç³»ç»Ÿä¸»æœºå
# 3ï¸âƒ£ ä¿®æ”¹ SSH ç™»å½•é¡µæ¬¢è¿è¯­
# 4ï¸âƒ£ åŒæ­¥ /etc/openwrt_release ä¸ /etc/os-release
# ============================================================

CUSTOM_DATE=$(date +%Y.%m.%d)
CUSTOM_VERSION="Mz.Wrt 24.10.3 (${CUSTOM_DATE}) by Mr.Zhang"
CUSTOM_HOSTNAME="MzWrt-Router"
LUCIBRANCH="LuCI openwrt-24.10 branch"

echo "ğŸ§© æ­£åœ¨å†™å…¥è‡ªå®šä¹‰ç³»ç»Ÿä¿¡æ¯..."

# ------------------ ä¸»æœºå ------------------
uci set system.@system[0].hostname="${CUSTOM_HOSTNAME}"
uci commit system
echo "${CUSTOM_HOSTNAME}" > /proc/sys/kernel/hostname

# ------------------ openwrt_release ------------------
if [ -f /etc/openwrt_release ]; then
    sed -i "s/DISTRIB_DESCRIPTION='[^']*'/DISTRIB_DESCRIPTION='${CUSTOM_VERSION} \/ ${LUCIBRANCH}'/" /etc/openwrt_release
else
    cat > /etc/openwrt_release <<EOF
DISTRIB_ID='ImmortalWrt'
DISTRIB_RELEASE='24.10.3'
DISTRIB_REVISION='Mz.Wrt'
DISTRIB_TARGET='custom/auto'
DISTRIB_DESCRIPTION='${CUSTOM_VERSION} \/ ${LUCIBRANCH}'
DISTRIB_TAINTS=''
EOF
fi

# ------------------ os-release ------------------
if [ -f /etc/os-release ]; then
    sed -i "s/^PRETTY_NAME=.*/PRETTY_NAME=\"${CUSTOM_VERSION}\"/" /etc/os-release
else
    cat > /etc/os-release <<EOF
NAME="ImmortalWrt"
ID="immortalwrt"
PRETTY_NAME="${CUSTOM_VERSION}"
EOF
fi

# ------------------ LuCI æ˜¾ç¤ºä¿®å¤ ------------------
# å¼ºåˆ¶é‡å†™ LuCI çš„ç³»ç»Ÿä¿¡æ¯ç¼“å­˜ï¼Œé˜²æ­¢ä»æ˜¾ç¤ºæ—§ç‰ˆæœ¬
[ -d /usr/lib/lua/luci/version.lua ] && rm -f /usr/lib/lua/luci/version.lua
if [ -f /usr/lib/lua/luci/version.lua ]; then
    sed -i "s/'LuCI .*'/'${CUSTOM_VERSION}'/" /usr/lib/lua/luci/version.lua 2>/dev/null
fi

# ------------------ SSH æ¬¢è¿è¯­ ------------------
BANNER_FILE="/etc/banner"
if [ -f "$BANNER_FILE" ]; then
    cat >> "$BANNER_FILE" <<EOF

============================================
 ğŸ§© ${CUSTOM_VERSION}
 ğŸ’¡ ${LUCIBRANCH}
 ğŸ–¥ï¸  Hostname: ${CUSTOM_HOSTNAME}
============================================
EOF
fi

# ------------------ æ ‡è¯†æ–‡ä»¶ ------------------
echo "${CUSTOM_VERSION}" > /etc/mz.version

# ------------------ æ¸…ç† ------------------
rm -f /etc/uci-defaults/99-custom.sh
exit 0

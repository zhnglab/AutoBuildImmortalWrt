#!/bin/sh
# ================== ğŸ§© è‡ªå®šä¹‰å›ºä»¶ä¿¡æ¯è„šæœ¬ ==================
# ä½œç”¨ï¼š
# 1ï¸âƒ£ LuCI æ¦‚è§ˆé¡µæ˜¾ç¤ºè‡ªå®šä¹‰ç‰ˆæœ¬ä¿¡æ¯
# 2ï¸âƒ£ SSH ç™»å½•æ¬¢è¿ä¿¡æ¯ä¸­æ˜¾ç¤ºè‡ªå®šä¹‰ç‰ˆæœ¬
# 3ï¸âƒ£ ç³»ç»Ÿæ–‡ä»¶ /etc/openwrt_release å’Œ /etc/os-release ä¿æŒä¸€è‡´
# ============================================================

CUSTOM_DATE=$(date +%Y.%m.%d)
CUSTOM_VERSION="Mz.Wrt 24.10.3 (${CUSTOM_DATE}) by Mr.Zhang"
LUCIBRANCH="LuCI openwrt-24.10 branch"

echo "ğŸ§© æ­£åœ¨å†™å…¥è‡ªå®šä¹‰ç‰ˆæœ¬ä¸ç³»ç»Ÿä¿¡æ¯..."

# --- ä¿®æ”¹ openwrt_release ---
if [ -f /etc/openwrt_release ]; then
    sed -i "s/DISTRIB_DESCRIPTION='[^']*'/DISTRIB_DESCRIPTION='${CUSTOM_VERSION} \/ ${LUCIBRANCH}'/" /etc/openwrt_release
else
    cat > /etc/openwrt_release <<EOF
DISTRIB_ID='OpenWrt'
DISTRIB_RELEASE='24.10.3'
DISTRIB_REVISION='Mz.Wrt'
DISTRIB_TARGET='custom/auto'
DISTRIB_DESCRIPTION='${CUSTOM_VERSION} \/ ${LUCIBRANCH}'
DISTRIB_TAINTS=''
EOF
fi

# --- ä¿®æ”¹ os-release ---
if [ -f /etc/os-release ]; then
    sed -i "s/^PRETTY_NAME=.*/PRETTY_NAME='${CUSTOM_VERSION}'/" /etc/os-release
    sed -i "s/^OPENWRT_RELEASE=.*/OPENWRT_RELEASE='${CUSTOM_VERSION}'/" /etc/os-release 2>/dev/null || true
else
    cat > /etc/os-release <<EOF
NAME="OpenWrt"
ID="openwrt"
PRETTY_NAME="${CUSTOM_VERSION}"
OPENWRT_RELEASE="${CUSTOM_VERSION}"
EOF
fi

# --- SSH ç™»å½•æ¬¢è¿è¯­ ---
BANNER_FILE="/etc/banner"
if [ -f "$BANNER_FILE" ]; then
    echo "" >> "$BANNER_FILE"
    echo "============================================" >> "$BANNER_FILE"
    echo " ğŸ§© ${CUSTOM_VERSION}" >> "$BANNER_FILE"
    echo " ğŸ’¡ ${LUCIBRANCH}" >> "$BANNER_FILE"
    echo "============================================" >> "$BANNER_FILE"
fi

# --- é˜²æ­¢é‡å¤æ‰§è¡Œ ---
rm -f /etc/uci-defaults/99-custom.sh
exit 0

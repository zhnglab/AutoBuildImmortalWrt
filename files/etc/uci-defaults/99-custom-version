#!/bin/sh
# ================== ðŸ§© è‡ªå®šä¹‰å›ºä»¶ä¿¡æ¯ by Mr.Zhang ==================
echo "ðŸ§© æ­£åœ¨å†™å…¥è‡ªå®šä¹‰ç‰ˆæœ¬ã€ä¸»æœºåä¸Žç•Œé¢ä¸»é¢˜..."

# 1ï¸âƒ£ åŠ¨æ€å®šä¹‰ç‰ˆæœ¬å·ï¼ˆåŒ…å«æž„å»ºæ—¥æœŸï¼‰
CUSTOM_DATE=$(date +%d.%m.%Y)
CUSTOM_VERSION="Mz.Wrt 24.10.3 ${CUSTOM_DATE} by Mr.Zhang"

# 2ï¸âƒ£ ä¿®æ”¹ /etc/openwrt_releaseï¼ˆLuCI æ¦‚è§ˆé¡µç”¨ï¼‰
FILE_PATH="/etc/openwrt_release"
if [ -f "$FILE_PATH" ]; then
    sed -i "s/DISTRIB_DESCRIPTION='[^']*'/DISTRIB_DESCRIPTION='${CUSTOM_VERSION} \/ LuCI openwrt-24.10 branch'/g" "$FILE_PATH"
else
    echo "DISTRIB_DESCRIPTION='${CUSTOM_VERSION} / LuCI openwrt-24.10 branch'" >> "$FILE_PATH"
fi

# 3ï¸âƒ£ ä¿®æ”¹ SSH ç™»å½•é¡µ banner
BANNER_FILE="/etc/banner"
if [ -f "$BANNER_FILE" ]; then
    # æ’å…¥åœ¨æœ€é¡¶éƒ¨
    sed -i "1i\\
${CUSTOM_VERSION}\\
------------------------------------\\
" "$BANNER_FILE"
else
    echo "${CUSTOM_VERSION}" > "$BANNER_FILE"
    echo "------------------------------------" >> "$BANNER_FILE"
fi

# 4ï¸âƒ£ ä¿®æ”¹ä¸»æœºåï¼ˆLuCI é¡¶éƒ¨å’Œç³»ç»Ÿä¿¡æ¯æ˜¾ç¤ºï¼‰
uci set system.@system[0].hostname='Mz.WRT'
uci commit system

# 5ï¸âƒ£ ä¿®æ”¹é»˜è®¤ä¸»é¢˜ä¸º Argonï¼ˆå¦‚æžœå®‰è£…äº† luci-theme-argonï¼‰
if uci show luci 2>/dev/null | grep -q 'theme'; then
    uci set luci.main.mediaurlbase='/luci-static/argon'
    uci commit luci
else
    echo "âš ï¸ æœªæ£€æµ‹åˆ° luci-theme-argonï¼Œè¯·ç¡®ä¿æž„å»ºæ—¶åŒ…å«æ­¤åŒ…ã€‚"
fi

# 6ï¸âƒ£ å¯é€‰ï¼šè®¾ç½®æ—¶åŒºä¸ºä¸­å›½ï¼ˆAsia/Shanghaiï¼‰
uci set system.@system[0].zonename='Asia/Shanghai'
uci set system.@system[0].timezone='CST-8'
uci commit system

echo "âœ… è‡ªå®šä¹‰è®¾ç½®å®Œæˆï¼šä¸»æœºåã€ä¸»é¢˜ã€ç‰ˆæœ¬ä¿¡æ¯ã€æ—¶åŒºã€‚"


# ================== ä¿®å¤ LuCI å›ºä»¶ç‰ˆæœ¬æ˜¾ç¤º ==================
CUSTOM_DATE=$(date +%d.%m.%Y)
CUSTOM_VERSION="${CUSTOM_DATE} by Mr.Zhang"

# å†™å…¥å¯åŠ¨åŽæ‰§è¡Œçš„ä»»åŠ¡ï¼ˆç¡®ä¿å¼€æœºåŽå†ä¿®æ”¹ç‰ˆæœ¬æ–‡ä»¶ï¼‰
RCLOCAL="/etc/rc.local"
grep -q "Mz.Wrt" "$RCLOCAL" 2>/dev/null || cat >> "$RCLOCAL" <<EOF

# è‡ªå®šä¹‰ç‰ˆæœ¬å·æ˜¾ç¤ºä¿®å¤
if [ -f /etc/openwrt_release ]; then
    sed -i "s/DISTRIB_DESCRIPTION='[^']*'/DISTRIB_DESCRIPTION='${CUSTOM_VERSION} \/ LuCI openwrt-24.10 branch'/g" /etc/openwrt_release
fi
exit 0
EOF

